<!doctype html>
<html>
<head>
  <title>Genetic Algorithm Art</title>
  <style>
    html, body {
      width: 100%;
      height: 100vh;
      padding: 0;
      margin: 0;
      box-sizing: border-box;
      background: #000;
    }
  </style>
</head>
<body>

<script src="Pixel.js"></script>
<script src="DNA.js"></script>
<script src="DOM.js"></script>
<script src="math.js"></script>
<script src="/shared/web/js/three.js"></script>
<script>
  var MAX_WIDTH = 20;
  var MAX_POPULATIONS = 10;

  var renderer, scene, camera, objs = [];

  function render(pixels, width) {
    var container = document.getElementById('container');
    container.style.height = Math.floor(container.offsetWidth * (9/16)) + 'px';
    console.log(container.offsetWidth, container.offsetHeight)
    renderer = new THREE.WebGLRenderer();
    camera =
      new THREE.PerspectiveCamera(
        45,
        container.offsetWidth / container.offsetHeight,
        0.1,
        10000,
      );

    scene = new THREE.Scene();

// Add the camera to the scene.
    scene.add(camera);

// Start the renderer.
    renderer.setSize(container.offsetWidth, container.offsetHeight);

// Attach the renderer-supplied
// DOM element.
    container.appendChild(renderer.domElement);


    // create a point light
    const pointLight =
      new THREE.PointLight(0xFFFFFF);

// set its position
    pointLight.position.x = 10;
    pointLight.position.y = 50;
    pointLight.position.z = 130;

// add to the scene
    scene.add(pointLight);




    const RADIUS = 1;
    const SEGMENTS = 3;
    const RINGS = 3;
    const sphereMaterial =
      new THREE.MeshLambertMaterial(
        {
          color: 0xCC0000
        });

    for (var i = 0; i < 1000; i++) {
      const sphere = new THREE.Mesh(
        new THREE.SphereGeometry(
          RADIUS,
          SEGMENTS,
          RINGS),
        sphereMaterial);
      sphere.position.x = i * RADIUS * 2;
      sphere.position.y = i * RADIUS;
      sphere.position.z = -20;
      objs.push(sphere);
      scene.add(sphere);
    }

    renderer.render(scene, camera);
    requestAnimationFrame(update);
  }

  function update () {
    objs.forEach((obj, i) => {
      obj.rotation.x += 0.05;
      obj.position.y = Math.min(Math.sin(obj.position.x), 5);
      obj.position.x -= 0.1;
      if (obj.position.x < -100) {
        obj.position.x = 100;
      }
    });
    renderer.render(scene, camera);
    requestAnimationFrame(update);
  }

  function genRandomPopulation(dataSize, populationSize) {
    var population = [];
    for (var p = 0; p < dataSize; p++) {
      var row = [];
      for (var i = 0; i < populationSize; i++) {
        row.push(new DNA(new Pixel(randInt(0, 255), randInt(0, 255), randInt(0, 255))));
      }
      population.push(row);
    }

    return population;
  }

  function start(e) {
    var img = e.target;
    var canvas = document.createElement('canvas');
    canvas.width = img.width;
    canvas.height = img.height;
    var ctx = canvas.getContext('2d');

    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

    var data = ctx.getImageData(0, 0, canvas.width, canvas.height);
    var kernel = Math.floor(data.width / MAX_WIDTH);
    var rowWidth = 0;
    var dataTarget = [];

    PixelList.takeRows(data.data, data.width * 4, (row, y) => {
      if (y % kernel === 0) {
        rowWidth = 0;
        for (let i = 0, len = row.length; i < len; i += 1) {
          if (i % kernel === 0) {
            const pixel = new Pixel(row[i][0], row[i][1], row[i][2]);
            dataTarget.push(pixel);
            rowWidth += 1;
          }
        }
      }
    });

    var population = genRandomPopulation(dataTarget.length, MAX_POPULATIONS);
    var worker = new Worker('worker.js');
    worker.addEventListener('message', (event) => {
      var data = event.data;
      var action = data.action || '';
      switch (action) {
        case 'render':
          render(data.pixels, data.width);
          break;
        case 'error':
          console.error(data.message, data);
          break;
        default:
          worker.postMessage({ action: 'error', message: 'Action not implemented', data: event.data });
      }
    });

    worker.postMessage({ action: 'bounce', width: rowWidth, pixels: dataTarget });
  }

  function init() {
    document.body.appendChild(el('div', { id: 'container' }, 'Loading...'));
    var img = document.createElement('img');
    img.addEventListener('load', start);
    img.setAttribute('src', '/gen-art/happy-sm.jpg');
  }

  init();
</script>
</body>
</html>