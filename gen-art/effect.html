<!doctype html>
<html>
<head>
  <title>Genetic Algorithm Art</title>
  <style>
    html, body {
      width: 100%;
      height: 100%;
      padding: 0;
      margin: 0;
    }
  </style>
</head>
<body>
<script>
  var VIEWPORT = initViewport();
  var ROWS = 100;
  var COLS = 100;
  var worker = new Worker('worker.js');

  var canvas = document.createElement('canvas');
  var ctx = canvas.getContext('2d');

  document.body.appendChild(canvas);

  var pixels = [];

  function render() {
    pixels.forEach(pixel => {
      const width = VIEWPORT.width / COLS;
      const height = VIEWPORT.height / ROWS;

      ctx.fillStyle = pixel.color;
      ctx.fillRect(pixel.pos.x * width, pixel.pos.y * height, width, height);

      if (pixel.transition) {
        pixel.tmp.width += pixel.vel.x;
        pixel.tmp.height += pixel.vel.y;

        if (pixel.tmp.width >= width) {
          pixel.tmp.width = width;
          pixel.tmp.height = height;
          pixel.transition = false;
          pixel.color = pixel.mix;
        }

        ctx.fillStyle = pixel.mix;
        ctx.fillRect(pixel.pos.x * width, pixel.pos.y * height, pixel.tmp.width | 0, pixel.tmp.height | 0);
      }
    });
  }

  function update() {
    pixels.forEach((pixel, i) => {
      if (!pixel.transition) {
        pixel.tmp = { width: 0, height: 0 };
        if (pixel.next) {
          pixel.mix = pixel.next;
          pixel.next = pixel.mix;

          delete pixel.next;
        } else {
          pixel.mix = pixels[i === 0 ? pixels.length - 1 : Math.max(0, i - 1)].color;
        }
        pixel.transition = true;
      }
    });
  }

  function loop() {
    if (!paused) {
      requestAnimationFrame(loop);
    }

    update();
    render();
  }

  worker.addEventListener('message', (event) => {
    const data = event.data;
    console.log(`Received: ${data.action}`);

    switch (data.action) {
      case 'update':
        pixels = data.pixels;
        break;
      case 'error':
        console.error(data.message, data);
        break;
      default:
        console.error('Invalid action type.', data);
    }
  });

  function prepImport() {
    const img = new Image();
    img.addEventListener('load', (e) => {
      const canvas = document.createElement('canvas');
      canvas.width = img.width;
      canvas.height = img.height;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(img, 0, 0);
      worker.postMessage({
        action: 'takeSome',
        img: ctx.getImageData(0, 0, canvas.width, canvas.height).data,
        pixels: pixels,
        imgWidth: img.width,
        width: COLS,
      })
    });
    img.src = 'happy-sm.jpg';
  }

  function init() {
    VIEWPORT = initViewport();
    canvas.width = VIEWPORT.width;
    canvas.height = VIEWPORT.height;

    ctx = canvas.getContext('2d');

    loop();
  }

  function initViewport() {
    return {
      width: document.body.offsetWidth,
      height: document.body.offsetHeight,
    };
  }

  var paused = false;
  var resizeTimer;
  window.addEventListener('resize', () => {
    clearTimeout(resizeTimer);
    resizeTimer = setTimeout(init, 1000);
  });

  document.body.addEventListener('keydown', () => {
    paused = true;
  });

  document.body.addEventListener('keyup', () => {
    paused = false;
    loop();
  });

  worker.postMessage({ action: 'random', width: COLS, height: ROWS });
  setTimeout(prepImport, 2500);
  init();
</script>
</body>
</html>